name: Claude Code Plan

on:
  repository_dispatch:
    types: [claude-plan]

jobs:
  plan:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get Issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ github.event.client_payload.issue_number }};
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            core.setOutput('title', issue.data.title);
            core.setOutput('body', issue.data.body || '');
            core.setOutput('number', issueNumber);

      - name: Run Claude Code for planning
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ISSUE_TITLE="${{ steps.issue.outputs.title }}"
          ISSUE_BODY="${{ steps.issue.outputs.body }}"
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"

          PROMPT="GitHub Issue #${ISSUE_NUMBER} ã®å®Ÿè£…è¨ˆç”»ã‚’ç«‹ã¦ã¦ãã ã•ã„ã€‚

          ã‚¿ã‚¤ãƒˆãƒ«: ${ISSUE_TITLE}

          å†…å®¹:
          ${ISSUE_BODY}

          ä»¥ä¸‹ã®å½¢å¼ã§è¨ˆç”»ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„:

          ## æ¦‚è¦
          (ä½•ã‚’å®Ÿè£…ã™ã‚‹ã‹ã®ç°¡æ½”ãªèª¬æ˜)

          ## å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«
          - ãƒ•ã‚¡ã‚¤ãƒ«1: å¤‰æ›´å†…å®¹
          - ãƒ•ã‚¡ã‚¤ãƒ«2: å¤‰æ›´å†…å®¹

          ## å®Ÿè£…æ‰‹é †
          1. ã‚¹ãƒ†ãƒƒãƒ—1
          2. ã‚¹ãƒ†ãƒƒãƒ—2

          ## ãƒªã‚¹ã‚¯ãƒ»æ³¨æ„ç‚¹
          - æ³¨æ„ç‚¹ãŒã‚ã‚Œã°è¨˜è¼‰

          ã‚³ãƒ¼ãƒ‰ã¯æ›¸ã‹ãšã€è¨ˆç”»ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"

          claude -p "$PROMPT" \
            --dangerously-skip-permissions \
            --max-budget-usd 1 \
            --output-format text > plan.md 2>&1 || true

          cat plan.md

      - name: Post plan to GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('plan.md', 'utf8');
            const issueNumber = ${{ steps.issue.outputs.number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `## ğŸ¤– Claude Code å®Ÿè£…è¨ˆç”»\n\n${plan}\n\n---\n*ã“ã®è¨ˆç”»ã¯Claude Codeã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`
            });

      - name: Notify Slack with plan
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"
          ISSUE_TITLE="${{ steps.issue.outputs.title }}"
          ISSUE_URL="https://github.com/${{ github.repository }}/issues/${ISSUE_NUMBER}"
          PLAN=$(cat plan.md | head -c 2500)

          # Escape special characters for JSON
          PLAN_ESCAPED=$(echo "$PLAN" | jq -Rs .)

          curl -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "{
              \"channel\": \"${SLACK_CHANNEL_ID}\",
              \"text\": \"Issue #${ISSUE_NUMBER} ã®å®Ÿè£…è¨ˆç”»ãŒå®Œæˆã—ã¾ã—ãŸ\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"ğŸ“‹ å®Ÿè£…è¨ˆç”»\",
                    \"emoji\": true
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Issue #${ISSUE_NUMBER}:* ${ISSUE_TITLE}\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": ${PLAN_ESCAPED}
                  }
                },
                {
                  \"type\": \"divider\"
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"ã“ã®è¨ˆç”»ã§å®Ÿè£…ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"âœ… å®Ÿè£…é–‹å§‹\",
                        \"emoji\": true
                      },
                      \"style\": \"primary\",
                      \"action_id\": \"approve_implementation\",
                      \"value\": \"${{ github.repository }}|${ISSUE_NUMBER}\"
                    },
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"ğŸ”„ å†è¨ˆç”»\",
                        \"emoji\": true
                      },
                      \"action_id\": \"replan\",
                      \"value\": \"${{ github.repository }}|${ISSUE_NUMBER}\"
                    },
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"âŒ å´ä¸‹\",
                        \"emoji\": true
                      },
                      \"style\": \"danger\",
                      \"action_id\": \"reject_implementation\",
                      \"value\": \"${{ github.repository }}|${ISSUE_NUMBER}\"
                    },
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"GitHub ã§ç¢ºèª\",
                        \"emoji\": true
                      },
                      \"url\": \"${ISSUE_URL}\"
                    }
                  ]
                }
              ]
            }"
