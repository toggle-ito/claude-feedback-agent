name: Claude Code Implement

on:
  repository_dispatch:
    types: [claude-implement]

jobs:
  implement:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get Issue details
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ github.event.client_payload.issue_number }};
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            // Get comments to find the plan
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const planComment = comments.data.find(c => c.body.includes('Claude Code ÂÆüË£ÖË®àÁîª'));
            const plan = planComment ? planComment.body : '';

            core.setOutput('title', issue.data.title);
            core.setOutput('body', issue.data.body || '');
            core.setOutput('number', issueNumber);
            core.setOutput('plan', plan);

      - name: Create feature branch
        run: |
          BRANCH_NAME="fix/issue-${{ steps.issue.outputs.number }}"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Run Claude Code implementation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ISSUE_TITLE="${{ steps.issue.outputs.title }}"
          ISSUE_BODY="${{ steps.issue.outputs.body }}"
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"

          PROMPT="GitHub Issue #${ISSUE_NUMBER} „ÇíÂÆüË£Ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

          „Çø„Ç§„Éà„É´: ${ISSUE_TITLE}

          ÂÜÖÂÆπ:
          ${ISSUE_BODY}

          Ë¶Å‰ª∂:
          - Êó¢Â≠ò„ÅÆ„Ç≥„Éº„Éâ„Çπ„Çø„Ç§„É´„Å´Âæì„Å£„Å¶„Åè„Å†„Åï„ÅÑ
          - TypeScript „ÅÆÂûã„ÇíÈÅ©Âàá„Å´‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          - ÂøÖË¶Å„Å´Âøú„Åò„Å¶„ÉÜ„Çπ„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ
          - „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÅØÊó•Êú¨Ë™û„ÅßÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ"

          claude -p "$PROMPT" \
            --dangerously-skip-permissions \
            --max-budget-usd 5 \
            --output-format text > implementation.log 2>&1 || true

          cat implementation.log

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            git commit -m "fix: Issue #${{ steps.issue.outputs.number }} „ÅÆÂÆüË£Ö

          ${{ steps.issue.outputs.title }}

          Co-Authored-By: Claude <noreply@anthropic.com>"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          fi

      - name: Push branch
        if: env.HAS_CHANGES == 'true'
        run: git push -u origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: env.HAS_CHANGES == 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --title "fix: Issue #${{ steps.issue.outputs.number }} - ${{ steps.issue.outputs.title }}" \
            --body "## Summary

          Issue #${{ steps.issue.outputs.number }} „ÅÆËá™ÂãïÂÆüË£Ö„Åß„Åô„ÄÇ

          ## Related Issue

          Closes #${{ steps.issue.outputs.number }}

          ## Implementation Details

          $(cat implementation.log | tail -100)

          ---
          ü§ñ *Generated by Claude Code*" \
            --base main)

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      - name: Notify Slack on success
        if: env.HAS_CHANGES == 'true'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          PR_URL="${{ steps.pr.outputs.pr_url }}"
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"
          ISSUE_TITLE="${{ steps.issue.outputs.title }}"

          curl -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "{
              \"channel\": \"${SLACK_CHANNEL_ID}\",
              \"text\": \"Issue #${ISSUE_NUMBER} „ÅÆÂÆüË£Ö„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"‚úÖ ÂÆüË£ÖÂÆå‰∫Ü\",
                    \"emoji\": true
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*Issue #${ISSUE_NUMBER}:* ${ISSUE_TITLE}\"
                  }
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"üîç PR„ÇíÁ¢∫Ë™ç\",
                        \"emoji\": true
                      },
                      \"url\": \"${PR_URL}\",
                      \"style\": \"primary\"
                    }
                  ]
                }
              ]
            }"

      - name: Notify Slack on no changes
        if: env.HAS_CHANGES == 'false'
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
        run: |
          ISSUE_NUMBER="${{ steps.issue.outputs.number }}"

          curl -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer ${SLACK_BOT_TOKEN}" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d "{
              \"channel\": \"${SLACK_CHANNEL_ID}\",
              \"text\": \"Issue #${ISSUE_NUMBER} „ÅÆÂÆüË£Ö„ÅßÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"‚ö†Ô∏è Â§âÊõ¥„Å™„Åó\",
                    \"emoji\": true
                  }
                },
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"Issue #${ISSUE_NUMBER} „ÅÆÂÆüË£Ö„ÇíË©¶„Åø„Åæ„Åó„Åü„Åå„ÄÅ„Ç≥„Éº„Éâ„ÅÆÂ§âÊõ¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\"
                  }
                }
              ]
            }"
